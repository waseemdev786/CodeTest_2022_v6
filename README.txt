The code is not optimized because there are many query optimizations in this code that can be done like relationshop calls etc and code style is also not clean. There are many places where we could remove code duplication and extra if else conditions to make it clean and readable.
